openapi: 3.0.3
info:
  title: IT CRM API
  version: 1.0.0
  description: >
    OpenAPI dokumentacija za Next.js API rute u app/api.
    Auth je cookie-based (HttpOnly cookie: itcrm_session). Pozovi /api/auth/login u Swagger-u,
    pa Ä‡e naredni pozivi automatski nositi cookie.

servers:
  - url: http://localhost:3000

tags:
  - name: Auth
  - name: Client Categories
  - name: Client Companies
  - name: Contacts
  - name: Opportunities
  - name: Activities
  - name: Metrics
  - name: Admin

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: itcrm_session

  schemas:
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
      required: [message]

    OkResponse:
      type: object
      properties:
        ok:
          type: boolean
      required: [ok]

    Role:
      type: string
      enum: [admin, sales_manager, freelance_consultant]

    User:
      type: object
      properties:
        id: { type: integer, format: int32 }
        name: { type: string }
        email: { type: string, format: email }
        role: { $ref: "#/components/schemas/Role" }
        isActive: { type: boolean }
        managerId: { type: integer, format: int32 }
      required: [id, name, email, role, isActive, managerId]

    Me:
      type: object
      properties:
        id: { type: integer, format: int32 }
        name: { type: string }
        email: { type: string, format: email }
        role: { $ref: "#/components/schemas/Role" }
      required: [id, name, email, role]

    ClientCategory:
      type: object
      properties:
        id: { type: integer, format: int32 }
        name: { type: string }
      required: [id, name]

    ClientCompanyStatus:
      type: string
      enum: [lead, active, inactive, paused]

    ClientCompany:
      type: object
      properties:
        id: { type: integer, format: int32 }
        name: { type: string }
        industry: { type: string }
        companySize: { type: string }
        website:
          type: string
          nullable: true
        country: { type: string }
        city: { type: string }
        address: { type: string }
        status: { $ref: "#/components/schemas/ClientCompanyStatus" }
        categoryId: { type: integer, format: int32 }
        salesManagerId: { type: integer, format: int32 }
        freelanceConsultantId: { type: integer, format: int32 }
        category:
          allOf:
            - $ref: "#/components/schemas/ClientCategory"
          nullable: true
      required:
        - id
        - name
        - industry
        - companySize
        - country
        - city
        - address
        - status
        - categoryId
        - salesManagerId
        - freelanceConsultantId

    Contact:
      type: object
      properties:
        id: { type: integer, format: int32 }
        name: { type: string }
        email: { type: string, format: email }
        phone:
          type: string
          nullable: true
        position: { type: string }
        clientCompanyId: { type: integer, format: int32 }
        salesManagerId: { type: integer, format: int32 }
        freelanceConsultantId: { type: integer, format: int32 }
        clientCompany:
          allOf:
            - $ref: "#/components/schemas/ClientCompany"
          nullable: true
      required:
        - id
        - name
        - email
        - position
        - clientCompanyId
        - salesManagerId
        - freelanceConsultantId

    OpportunityStage:
      type: string
      enum: [prospecting, discovery, proposal, negotiation, won, lost]

    OpportunityStatus:
      type: string
      enum: [open, closed]

    Opportunity:
      type: object
      properties:
        id: { type: integer, format: int32 }
        title: { type: string }
        description:
          type: string
          nullable: true
        stage: { $ref: "#/components/schemas/OpportunityStage" }
        status: { $ref: "#/components/schemas/OpportunityStatus" }
        estimatedValue: { type: number }
        currency: { type: string }
        probability: { type: number, minimum: 0, maximum: 1 }
        expectedCloseDate:
          type: string
          format: date-time
          nullable: true
        contactId: { type: integer, format: int32 }
        salesManagerId: { type: integer, format: int32 }
        freelanceConsultantId: { type: integer, format: int32 }
        clientCompanyId:
          type: integer
          format: int32
          nullable: true
        contact:
          allOf:
            - $ref: "#/components/schemas/Contact"
          nullable: true
        clientCompany:
          allOf:
            - $ref: "#/components/schemas/ClientCompany"
          nullable: true
      required:
        - id
        - title
        - stage
        - status
        - estimatedValue
        - currency
        - probability
        - contactId
        - salesManagerId
        - freelanceConsultantId

    ActivityType:
      type: string
      enum: [note, call, meeting]

    ActivityEntityType:
      type: string
      enum: [clientCompany, opportunity]

    Activity:
      type: object
      properties:
        id: { type: string, format: uuid }
        userId: { type: integer, format: int32 }
        entityType: { $ref: "#/components/schemas/ActivityEntityType" }
        entityId: { type: integer, format: int32 }
        type: { $ref: "#/components/schemas/ActivityType" }
        description: { type: string }
        createdAt: { type: string, format: date-time }
      required: [id, userId, entityType, entityId, type, description, createdAt]

    PagedResultClientCompanies:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/ClientCompany" }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }
      required: [items, total, page, pageSize]

    PagedResultContacts:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/Contact" }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }
      required: [items, total, page, pageSize]

    PagedResultOpportunities:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/Opportunity" }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }
      required: [items, total, page, pageSize]

    PagedResultUsers:
      type: object
      properties:
        items:
          type: array
          items: { $ref: "#/components/schemas/User" }
        total: { type: integer }
        page: { type: integer }
        pageSize: { type: integer }
      required: [items, total, page, pageSize]

    TeamMetrics:
      type: object
      properties:
        totalOpportunities: { type: integer }
        opportunitiesByStage:
          type: object
          additionalProperties: { type: integer }
        wonDeals: { type: integer }
        totalEstimatedValue: { type: number }
      required: [totalOpportunities, opportunitiesByStage, wonDeals, totalEstimatedValue]

paths:
  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, minLength: 1 }
                email: { type: string, format: email }
                password: { type: string, minLength: 6 }
                role: { $ref: "#/components/schemas/Role" }
                managerId:
                  type: integer
                  format: int32
                  nullable: true
              required: [name, email, password, role]
      responses:
        "200":
          description: Created user
          content:
            application/json:
              schema: { $ref: "#/components/schemas/User" }
        "409":
          description: Conflict
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Login (sets HttpOnly cookie)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 1 }
              required: [email, password]
      responses:
        "200":
          description: Logged in (cookie set)
          headers:
            Set-Cookie:
              schema:
                type: string
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Me" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: Logout (clears cookie)
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Logged out
          content:
            application/json:
              schema: { $ref: "#/components/schemas/OkResponse" }

  /api/auth/me:
    get:
      tags: [Auth]
      summary: Current user
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Me
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Me" }
        "401":
          description: Not logged in
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/client-categories:
    get:
      tags: [Client Categories]
      summary: List client categories
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Categories
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ClientCategory" }
    post:
      tags: [Client Categories]
      summary: Create client category (admin only)
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, minLength: 1 }
              required: [name]
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ClientCategory" }
        "403":
          description: Forbidden (role)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/client-categories/{id}:
    patch:
      tags: [Client Categories]
      summary: Update category name (admin only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, minLength: 1 }
              required: [name]
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ClientCategory" }
        "403":
          description: Forbidden (role)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/client-companies:
    get:
      tags: [Client Companies]
      summary: List client companies
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20, maximum: 50 }
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: city
          schema: { type: string }
        - in: query
          name: status
          schema: { $ref: "#/components/schemas/ClientCompanyStatus" }
      responses:
        "200":
          description: Paged result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedResultClientCompanies" }

    post:
      tags: [Client Companies]
      summary: Create client company (sales_manager only)
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, minLength: 1 }
                industry: { type: string, minLength: 1 }
                companySize: { type: string, minLength: 1 }
                website:
                  type: string
                  nullable: true
                country: { type: string, minLength: 1 }
                city: { type: string, minLength: 1 }
                address: { type: string, minLength: 1 }
                status: { $ref: "#/components/schemas/ClientCompanyStatus" }
                categoryId: { type: integer, format: int32 }
                salesManagerId: { type: integer, format: int32 }
                freelanceConsultantId: { type: integer, format: int32 }
              required:
                - name
                - industry
                - companySize
                - country
                - city
                - address
                - status
                - categoryId
                - salesManagerId
                - freelanceConsultantId
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ClientCompany" }
        "403":
          description: Forbidden (role)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/client-companies/{id}:
    get:
      tags: [Client Companies]
      summary: Get client company by id
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Details
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ClientCompany" }
        "403":
          description: Forbidden (RBAC)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    patch:
      tags: [Client Companies]
      summary: Update client company (sales_manager only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                industry: { type: string }
                companySize: { type: string }
                website:
                  type: string
                  nullable: true
                country: { type: string }
                city: { type: string }
                address: { type: string }
                status: { $ref: "#/components/schemas/ClientCompanyStatus" }
                categoryId: { type: integer, format: int32 }
                freelanceConsultantId: { type: integer, format: int32 }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ClientCompany" }
        "403":
          description: Forbidden (role/RBAC)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/contacts:
    get:
      tags: [Contacts]
      summary: List contacts
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20, maximum: 50 }
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: companyId
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Paged result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedResultContacts" }

    post:
      tags: [Contacts]
      summary: Create contact (sales_manager only)
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, minLength: 1 }
                email: { type: string, format: email }
                phone:
                  type: string
                  nullable: true
                position: { type: string, minLength: 1 }
                clientCompanyId: { type: integer, format: int32 }
                salesManagerId: { type: integer, format: int32 }
                freelanceConsultantId: { type: integer, format: int32 }
              required: [name, email, position, clientCompanyId, salesManagerId, freelanceConsultantId]
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Contact" }

  /api/contacts/{id}:
    get:
      tags: [Contacts]
      summary: Get contact by id
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Contact
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Contact" }
        "403":
          description: Forbidden (RBAC)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    patch:
      tags: [Contacts]
      summary: Update contact (sales_manager only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                email: { type: string, format: email }
                phone:
                  type: string
                  nullable: true
                position: { type: string }
                clientCompanyId: { type: integer, format: int32 }
                freelanceConsultantId: { type: integer, format: int32 }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Contact" }

  /api/opportunities:
    get:
      tags: [Opportunities]
      summary: List opportunities
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20, maximum: 50 }
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: stage
          schema: { $ref: "#/components/schemas/OpportunityStage" }
        - in: query
          name: status
          schema: { $ref: "#/components/schemas/OpportunityStatus" }
      responses:
        "200":
          description: Paged result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedResultOpportunities" }

    post:
      tags: [Opportunities]
      summary: Create opportunity (sales_manager only)
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string, minLength: 1 }
                description:
                  type: string
                  nullable: true
                stage: { $ref: "#/components/schemas/OpportunityStage" }
                status: { $ref: "#/components/schemas/OpportunityStatus" }
                estimatedValue: { type: number, minimum: 0 }
                currency: { type: string, minLength: 1 }
                probability: { type: number, minimum: 0, maximum: 1 }
                expectedCloseDate:
                  type: string
                  nullable: true
                  description: Use ISO date string (YYYY-MM-DD) or full ISO date-time.
                contactId: { type: integer, format: int32 }
                salesManagerId: { type: integer, format: int32 }
                freelanceConsultantId: { type: integer, format: int32 }
                clientCompanyId:
                  type: integer
                  format: int32
                  nullable: true
              required:
                - title
                - stage
                - status
                - estimatedValue
                - currency
                - probability
                - contactId
                - salesManagerId
                - freelanceConsultantId
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Opportunity" }

  /api/opportunities/{id}:
    get:
      tags: [Opportunities]
      summary: Get opportunity by id
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Opportunity
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Opportunity" }
        "403":
          description: Forbidden (RBAC)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

    patch:
      tags: [Opportunities]
      summary: Update opportunity (sales_manager only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string }
                description:
                  type: string
                  nullable: true
                stage: { $ref: "#/components/schemas/OpportunityStage" }
                status: { $ref: "#/components/schemas/OpportunityStatus" }
                estimatedValue: { type: number, minimum: 0 }
                currency: { type: string }
                probability: { type: number, minimum: 0, maximum: 1 }
                expectedCloseDate:
                  type: string
                  nullable: true
                contactId: { type: integer, format: int32 }
                freelanceConsultantId: { type: integer, format: int32 }
                clientCompanyId:
                  type: integer
                  format: int32
                  nullable: true
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Opportunity" }

  /api/activities:
    get:
      tags: [Activities]
      summary: List activities (max 200)
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: entityType
          schema: { $ref: "#/components/schemas/ActivityEntityType" }
        - in: query
          name: entityId
          schema: { type: integer, format: int32 }
      responses:
        "200":
          description: Activities
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Activity" }

    post:
      tags: [Activities]
      summary: Create activity
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                entityType: { $ref: "#/components/schemas/ActivityEntityType" }
                entityId: { type: integer, format: int32 }
                type: { $ref: "#/components/schemas/ActivityType" }
                description: { type: string, minLength: 1 }
              required: [entityType, entityId, type, description]
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Activity" }

  /api/metrics/team:
    get:
      tags: [Metrics]
      summary: Team metrics (sales_manager) or global (admin)
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: from
          schema:
            type: string
            description: ISO date (YYYY-MM-DD). Filters by expectedCloseDate >= from.
        - in: query
          name: to
          schema:
            type: string
            description: ISO date (YYYY-MM-DD). Filters by expectedCloseDate <= to.
      responses:
        "200":
          description: Metrics
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TeamMetrics" }

  /api/admin/users:
    get:
      tags: [Admin]
      summary: List users (admin only)
      security:
        - cookieAuth: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20, maximum: 50 }
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: role
          schema: { $ref: "#/components/schemas/Role" }
        - in: query
          name: isActive
          schema: { type: boolean }
      responses:
        "200":
          description: Paged users
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PagedResultUsers" }

    post:
      tags: [Admin]
      summary: Create user (admin only)
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string, minLength: 1 }
                email: { type: string, format: email }
                password: { type: string, minLength: 6 }
                role: { $ref: "#/components/schemas/Role" }
                managerId: { type: integer, format: int32 }
              required: [name, email, password, role, managerId]
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/User" }

  /api/admin/users/{id}:
    patch:
      tags: [Admin]
      summary: Update user (admin only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                email: { type: string, format: email }
                password:
                  type: string
                  description: Optional. If provided, will be hashed.
                role: { $ref: "#/components/schemas/Role" }
                isActive: { type: boolean }
                managerId: { type: integer, format: int32 }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/User" }

  /api/admin/reassign/client-companies/{id}:
    post:
      tags: [Admin]
      summary: Reassign client company owners (admin only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                salesManagerId: { type: integer, format: int32 }
                freelanceConsultantId: { type: integer, format: int32 }
              required: [salesManagerId, freelanceConsultantId]
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ClientCompany" }

  /api/admin/reassign/opportunities/{id}:
    post:
      tags: [Admin]
      summary: Reassign opportunity owners (admin only)
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int32 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                salesManagerId: { type: integer, format: int32 }
                freelanceConsultantId: { type: integer, format: int32 }
              required: [salesManagerId, freelanceConsultantId]
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Opportunity" }
